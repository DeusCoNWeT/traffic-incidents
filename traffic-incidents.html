<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!--
Show a timeline of traffic issues. Its use two api:

- **Google Maps Geocoding API**: to convert any address to geographical coordinates.

- **Bing Maps Traffic API**    : to get information about traffic issues in any city.

Example:
```
<traffic-incidents city="Madrid" api_key_geocoding="your_google_geocoding_key"
app_key_traffic="yout_bing_maps_key" auto_refresh refresh_time="60000">
```

@demo demo/index.html
@hero hero.svg
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="traffic-incidents-data.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">

<dom-module id="traffic-incidents">
  <template>
  <style>
  :host {
    display: inline-block;
    box-sizing: border-box;
    width: var(--ti-width, 240px);
    height: var(--ti-height, 240px);
  }

  paper-header-panel {
    width: 100%;
    height: 100%;
    @apply(--shadow-elevation-3dp);
  }
  .paper-header {
    height: var(--ti-header-height, 50px);
    font-size: 16px;
    line-height: 50px;
    padding: 0 10px;
    color: white;
    font-weight: bold;
    transition: height 0.2s;
    background-color:#B2002F;
    z-index:10;
    @apply(--ti-header);
  }
  .card {
    border-bottom: 1px solid black;
    padding:5px;
    @aply(--ti-card);
  }
  .content {
    margin-top: -5px;
    @apply(--ti-content);
  }
  </style>
  <traffic-incidents-data city="{{city}}" api_key_geocoding="{{api_key_geocoding}}"
  app_key_traffic="{{app_key_traffic}}" auto_refresh="{{auto_refresh}}" refresh_time="{{refresh_time}}"
  traffic_info="{{traffic_info}}" radio="{{radio}}"></traffic-incidents-data>

  <paper-header-panel mode="waterfall-tall">
    <div class="paper-header">Traffic Incidents</div>
    <div class="content">
      <template is="dom-repeat" items="{{traffic_info}}">
        <div class="card">
          <p>{{item.description}}</p>
        </div>
      </template>
    </div>
  </paper-header-panel>

</template>

<script>
  Polymer({
    is: 'traffic-incidents',

    properties: {
      /*
      * Google geoencody api_key.
      * Go to https://developers.google.com/maps/documentation/geocoding/get-api-key
      * to get your key
      **/
      api_key_geocoding: {
        type: String,
        reflectToAttribute: true
      },
      /*
      * Bing maps key.
      * Go to https://msdn.microsoft.com/en-us/library/ff428642.aspx
      * to get your key
      *
      */
      app_key_traffic: {
        type: String,
        reflectToAttribute: true
      },

      /*
      * `City` where you want to obtain traffic information
      */
      city: {
        type: String,
        reflectToAttribute: true,
        notify:true
      },

      /*
      * Radio (Km value) around city location where traffic information will be searched.
      */
      radio: {
        type: Number,
        reflectToAttribute: true,
        notify: true
      },
      /*
      * Traffic information obtained from Bing Maps Traffic API
      */
      traffic_info: {
        value: function(){return []},
        type: Array,
        notify: true
      },
      /*
      * `auto_refresh` is true when we want to refresh automatically each any (`refresh_time`) seconds
      */
      auto_refresh: {
        value: false,
        type: Boolean,
        reflectToAttribute: true,
        notify: true
      },
      /*
      * How often traffic information is requested if `auto_refresh` is true
      */
      refresh_time: {
        value: 120000,
        type: Number,
        reflectToAttribute: true
      },
      /** Transform dates recived from Bing Traffic Api to correct date format
      * @method getDate
      * @param {String} Date Date returned by Bing Traffic Api with format "/Date(timestamp)/"
      * @return {Date} a data object
      */
      getDate: function(stringDate){
        var timestamp = stringDate.match(/\/Date\(([^\)]*)\)\//);
        var date;
        if (timestamp.length > 1 ) {
          date = new Date(parseInt(timestamp[1]));
        }
        return date;
      },
    }
  });
</script>
</dom-module>
